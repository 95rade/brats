#!/bin/bash -l

set -eo pipefail
trap 'echo "error in $0 ${BASH_SOURCE} ${LINENO}"' ERR

should_upload=true
host=""
org="pivotal"
space="integration"
version=""
git_branch="master"
stack=""
BUILDPACK_WORKSPACE=${BUILDPACK_WORKSPACE:-${HOME}/workspace}

usage() {
  echo "Usage: $0

  Options:
      [--language=LANGUAGE] # REQUIRED - Specifies the set of binaries to be tested.
                            # Possible values: ruby, python, go, nodejs, php
      [--host=HOST]         # Specifies the host to target for running tests.
                            # Example: ci-8.example.com
      [--org=ORGANIZATION]  # The CF organization to use for tests
      [--space=SPACE]       # The CF space to use for tests
      [--no-upload]         # Specifies whether to upload local buildpack to cf.
                            # Default: false
      [--version=VERSION]   # Specifies a version of the language to run the BRATs suite of tests against.
                            # Default: [runs BRATs against all versions]
      [--branch=BRANCH]     # Specifies which git branch of the buildpack to run tests against.
                            # Default: master
      [--stack=STACK]       # Specifies which stack to run tests against.
                            # Default: all"
  exit 1
}

indent() {
  echo -e "\n******* $1"
}

configure_stack() {
  if [ "$host" == "" ]; then
    host=10.244.0.34.xip.io
    export VAGRANT_CWD="$HOME/workspace/bosh-lite"
    $VAGRANT_CWD/bin/add-route
  fi

  if [ "$stack" == "" ]; then
    indent "Using the host '$host'"
  else
    indent "Using the stack '$stack' against the host '$host'"
  fi
}

configure_cf() {
  indent "Connecting to CF"
  cf api api.$host --skip-ssl-validation
  cf_password=${CF_PASSWORD:-"admin"}
  cf login -u admin -p "${cf_password}" -o "${org}" -s "${space}"
}

while [ "$#" -gt 0 ]; do
  case $1 in
    -h|-\?|--help|help)
        usage
        exit
        ;;
    --language=*)
      if [ "$#" == "" ]; then
        usage
      else
        language=${1#*=}
      fi
      ;;
    --host=*)
      host=${1#*=}
      ;;
    --org=*)
      org=${1#*=};;
    --space=*)
      space=${1#*=};;
    --no-upload)
      should_upload=false;;
    --version=*)
      version=${1#*=};;
    --branch=*)
      git_branch=${1#*=};;
    --stack=*)
      stack=${1#*=};;
    -?*)
      echo "Unrecognized option ($1) submitted"
      usage
      ;;
    *)
  esac
  shift
done

if [ "$language" == "" ]; then
  usage
fi

configure_stack
configure_cf

upload_buildpack() {
  local name=$1

  indent "Checking out buildpack"
  mkdir -p tmp/
  git clone https://github.com/cloudfoundry/$name-buildpack tmp/$name-buildpack

  set +e
  pushd tmp/$name-buildpack
    indent "Checking out branch $git_branch"
    git checkout $git_branch
    git submodule update --init --recursive

    indent "Creating cached buildpack $name"
    BUNDLE_GEMFILE=cf.Gemfile bundle install
    BUNDLE_GEMFILE=cf.Gemfile bundle exec buildpack-packager cached
    indent "Deleting previous buildpack"
    cf delete-buildpack $name-brat-buildpack -f
    indent "Uploading buildpack"
    pattern="*_buildpack-cached*.zip"
    cf create-buildpack $name-brat-buildpack $(ls $pattern | head -n 1) 100 --enable
  popd
  set -e
}

on_close() {
  rm -Rf tmp/$language-buildpack
  cf delete-buildpack $language-brat-buildpack -f
}

trap on_close INT ERR

if [ "$should_upload" == "true" ]; then
  upload_buildpack $language
fi

version_tag=""
if [ "$version" != "" ]; then
  version_tag="--tag version:${version}"
fi

stack_tag=""
if [ "$stack" != "" ]; then
  stack_tag="--tag stack:${stack}"
fi

rspec \
  -f documentation \
  --require rspec/instafail \
  -f RSpec::Instafail \
  --color \
  cf_spec/integration/"$language"_spec.rb \
  $version_tag \
  $stack_tag
on_close
