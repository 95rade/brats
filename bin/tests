#!/usr/bin/env bash -l

set -eo pipefail

stack=lucid64
should_upload=true
host=""
BUILDPACK_WORKSPACE=${BUILDPACK_WORKSPACE:-${HOME}/workspace}

usage() {
  echo "Usage: $0

  Options:
      [--language=LANGUAGE] # REQUIRED - Specifies the set of binaries to be tested.
                            # Possible values: ruby, python, go, nodejs, php
      [--no-upload]         # Specifies whether to upload local buildpack to cf.
                            # Default: false"
  exit 1
}

indent() {
  echo -e "\n******* $1"
}

configure_ruby_version() {
  if [ -d $HOME/.rvm/bin ] ; then
    indent "Configuring RVM"
    export PATH=$HOME/.rvm/bin:$PATH
    rvm use 2.1.5
  else
    indent "Using default ruby"
  fi
}

while [ "$#" -gt 0 ]; do
  case $1 in
    -h|-\?|--help|help)
        usage
        exit
        ;;
    --language=*)
      if [ "$#" == "" ]; then
        usage
      else
        language=${1#*=}
      fi
      ;;
    --no-upload)
      should_upload=false;;
    -?*)
      echo "Unrecognized option ($1) submitted"
      usage
      ;;
    *)
  esac
  shift
done

if [ "$language" == "" ]; then
  usage
fi

configure_ruby_version
indent "Fetching CF CLI details"
cf api

upload_buildpack() {
  local name=$1
  pushd ${BUILDPACK_WORKSPACE}/$name-buildpack
    indent "Creating cached buildpack $name"
    pattern="*_buildpack-cached*.zip"
    rm -f $pattern
    BUNDLE_GEMFILE=cf.Gemfile time bundle exec buildpack-packager cached
    indent "Deleting previous buildpack"
    cf delete-buildpack $name-brat-buildpack -f
    indent "Uploading buildpack"
    cf create-buildpack $name-brat-buildpack $(ls $pattern | head -n 1) 100 --enable
  popd
}

on_close() {
  cf delete-buildpack $language-brat-buildpack -f
  cf delete simple_brats -f
}

if [ "$should_upload" == "true" ]; then
  upload_buildpack $language
fi

trap on_close INT

BUNDLE_GEMFILE=cf.Gemfile rspec -f documentation --color cf_spec/integration/"$language"_spec.rb
